import{c as d,f as m,ha as n,ja as f}from"./chunk-MRSHGPQQ.js";import{$b as p,Ea as l,Hb as g,K as s,L as h,W as u,q as c}from"./chunk-3YTOVYWG.js";var b=class i{constructor(e){this.http=e;this.loadUserFromToken()}API_URL="http://localhost:8080/api";REQUEST_TIMEOUT=1e4;currentUserSubject=new c(null);currentUser$=this.currentUserSubject.asObservable();authToken=null;loadUserFromToken(){let e=this.getTokenFromCookie();e&&(this.authToken=e,this.getCurrentUser().subscribe({error:r=>{console.warn("Failed to load user from stored token:",r),this.removeToken()}}))}getTokenFromCookie(){let e="auth_token=",t=decodeURIComponent(document.cookie).split(";");for(let a=0;a<t.length;a++){let o=t[a];for(;o.charAt(0)===" ";)o=o.substring(1);if(o.indexOf(e)===0)return o.substring(e.length,o.length)}return null}getToken(){return this.authToken}setToken(e){if(!e||e.trim()===""){console.error("Attempted to set empty or invalid token");return}this.authToken=e}removeToken(){this.authToken=null,document.cookie="auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"}isAuthenticated(){let e=this.getToken();return!!e&&e.trim()!==""}getCurrentUser(){let e=this.getToken();if(!e)return s(null);let r=new n().set("Authorization",`Bearer ${e}`);return this.http.get(`${this.API_URL}/auth/me`,{headers:r}).pipe(u(this.REQUEST_TIMEOUT),g(1),p(t=>{t&&this.currentUserSubject.next(t)}),l(t=>(console.error("Error fetching current user:",t),t.status===401||t.status===403?(console.warn("Authentication failed, logging out user"),this.logout().subscribe()):t.status===0?console.error("Network error - server may be unavailable"):console.error("Unexpected error:",t.message),s(null))))}login(e){if(!e||e!=="google"&&e!=="github"){console.error("Invalid OAuth provider:",e);return}this.redirectToOAuth(e)}redirectToOAuth(e){try{window.location.href=`${this.API_URL.replace("/api","")}/oauth2/authorization/${e}`}catch(r){console.error("Error redirecting to OAuth provider:",r)}}handleAuthCallback(){this.getCurrentUser().subscribe({next:e=>{e&&console.log("User authenticated successfully:",e.email)},error:e=>{console.error("Failed to fetch user after auth callback:",e),this.logout().subscribe()}})}logout(){let e=this.getToken();if(this.removeToken(),this.currentUserSubject.next(null),e){let r=new n().set("Authorization",`Bearer ${e}`);return this.http.post(`${this.API_URL}/auth/logout`,{},{headers:r}).pipe(u(this.REQUEST_TIMEOUT),l(t=>(console.warn("Error during server logout:",t),s({message:"Logged out locally"}))))}return s({message:"Logged out successfully"})}getAuthHeaders(){let e=this.getToken();if(!e)throw new Error("No authentication token available");return new n().set("Authorization",`Bearer ${e}`)}getAuthenticatedHeaders(){return this.getAuthHeaders()}handleApiError(e){let r="An unexpected error occurred";if(e.error&&typeof e.error=="object"){let t=e.error;r=t.message||r,t.errors&&console.error("Validation errors:",t.errors)}else e.message&&(r=e.message);return console.error("API Error:",{status:e.status,message:r,url:e.url}),h(()=>new Error(r))}static \u0275fac=function(r){return new(r||i)(m(f))};static \u0275prov=d({token:i,factory:i.\u0275fac,providedIn:"root"})};export{b as a};
